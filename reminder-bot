import asyncio
import json
import os
from datetime import datetime, timedelta
from typing import Dict, Optional
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤
CHAT_IDS = [
    -100**********,
    -100**********,
    -100**********,
    -100**********
]

REMINDERS_FILE = "reminders.json"

class ReminderBot:
    def __init__(self, bot_token: str):
        self.application = Application.builder().token(bot_token).build()
        self.reminders: Dict[str, dict] = self.load_reminders()
        self.running = True
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
        self.application.add_handler(CommandHandler("set_reminder", self.set_reminder))
        self.application.add_handler(CommandHandler("reminders", self.list_reminders))
        self.application.add_handler(CommandHandler("delete_reminder", self.delete_reminder))
        self.application.add_handler(CommandHandler("help", self.show_help))
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è —Ä—É—Å—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥
        self.application.add_handler(
            MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_russian_commands)
        )
        
        print("üü¢ [INFO] –ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        print(f"üîµ [INFO] –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.reminders)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏–∑ {REMINDERS_FILE}")

    def load_reminders(self) -> Dict[str, dict]:
        if os.path.exists(REMINDERS_FILE):
            try:
                with open(REMINDERS_FILE, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    print(f"üü¢ [SUCCESS] –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ {len(data)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏–∑ {REMINDERS_FILE}")
                    return data
            except Exception as e:
                print(f"üî¥ [ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}")
                return {}
        print("üü° [INFO] –§–∞–π–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫")
        return {}

    def save_reminders(self):
        try:
            with open(REMINDERS_FILE, 'w', encoding='utf-8') as f:
                json.dump(self.reminders, f, ensure_ascii=False, indent=2)
            print(f"üü¢ [SUCCESS] –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(self.reminders)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ {REMINDERS_FILE}")
        except Exception as e:
            print(f"üî¥ [ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}")

    async def check_reminders(self):
        current_time = datetime.now()
        to_remove = []

        for reminder_id, reminder_data in self.reminders.items():
            reminder_time = datetime.fromisoformat(reminder_data['time'])
            if current_time >= reminder_time:
                trigger_time = current_time.strftime('%d.%m.%Y %H:%M:%S')
                print(f"üîî [TRIGGER] –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –≤ {trigger_time}: {reminder_data['message']} (ID: {reminder_id})")
                await self.send_reminder(reminder_data)
                to_remove.append(reminder_id)
        
        # –£–¥–∞–ª—è–µ–º —Å—Ä–∞–±–æ—Ç–∞–≤—à–∏–µ
        for reminder_id in to_remove:
            del self.reminders[reminder_id]
            print(f"üóëÔ∏è [REMOVED] –£–¥–∞–ª–µ–Ω–æ —Å—Ä–∞–±–æ—Ç–∞–≤—à–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {reminder_id}")
        
        if to_remove:
            self.save_reminders()

    async def send_reminder(self, reminder_data: dict):
        try:
            chat_id = reminder_data['chat_id']
            topic_id = reminder_data.get('topic_id')
            user_id = reminder_data['user_id']
            
            await self.application.bot.send_message(
                chat_id=chat_id,
                message_thread_id=topic_id,
                text=f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!\n\n{reminder_data['message']}"
            )
            send_time = datetime.now().strftime('%d.%m.%Y %H:%M:%S')
            print(f"üì© [SENT] –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {send_time} –≤ —á–∞—Ç {chat_id} (–≤–µ—Ç–∫–∞: {topic_id}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        except Exception as e:
            print(f"üî¥ [ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {e}")

    def is_allowed_chat(self, chat_id: int) -> bool:
        result = chat_id in CHAT_IDS
        if not result:
            print(f"üö´ [DENIED] –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω –¥–ª—è —á–∞—Ç–∞ {chat_id}")
        return result

    async def set_reminder(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        topic_id = getattr(update.effective_message, 'message_thread_id', None)
        user_id = update.effective_user.id
        user_name = update.effective_user.first_name or "–ê–Ω–æ–Ω–∏–º"
        
        print(f"üìù [SET] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} ({user_id}) –ø—ã—Ç–∞–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ —á–∞—Ç–µ {chat_id} (–≤–µ—Ç–∫–∞: {topic_id})")
        
        if not self.is_allowed_chat(chat_id):
            await update.effective_message.reply_text("‚ùå –≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö.")
            return
        
        message_text = " ".join(context.args)
        if not message_text:
            await update.effective_message.reply_text(
                "‚ùå –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É/–≤—Ä–µ–º—è –∏–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ.\n"
                "–ü—Ä–∏–º–µ—Ä: `/set_reminder —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä`",
                parse_mode="Markdown"
            )
            print(f"‚ö†Ô∏è [SET] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –Ω–µ —É–∫–∞–∑–∞–ª –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è")
            return
        
        reminder_time, message = self.parse_reminder_input(message_text)
        if not reminder_time:
            await update.effective_message.reply_text(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n"
                "- `2025-12-25 15:30 –°–æ–æ–±—â–µ–Ω–∏–µ`\n"
                "- `—á–µ—Ä–µ–∑ 1 —á–∞—Å –°–æ–æ–±—â–µ–Ω–∏–µ`"
            )
            print(f"‚ö†Ô∏è [SET] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} —É–∫–∞–∑–∞–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: {message_text}")
            return
        
        reminder_id = f"{chat_id}_{topic_id or 0}_{int(reminder_time.timestamp())}"
        self.reminders[reminder_id] = {
            'chat_id': chat_id,
            'topic_id': topic_id,
            'user_id': user_id,
            'message': message,
            'time': reminder_time.isoformat(),
            'created_at': datetime.now().isoformat()
        }
        self.save_reminders()
        
        time_str = reminder_time.strftime('%d.%m.%Y %H:%M:%S')
        await update.effective_message.reply_text(
            f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ {time_str}\n"
            f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: {message}"
        )
        print(f"‚úÖ [SET SUCCESS] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} —É—Å—Ç–∞–Ω–æ–≤–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: '{message}' –Ω–∞ {time_str} (ID: {reminder_id})")

    async def handle_russian_commands(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä—É—Å—Å–∫–∏–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏"""
        text = update.effective_message.text.strip().lower()
        user_id = update.effective_user.id
        user_name = update.effective_user.first_name or "–ê–Ω–æ–Ω–∏–º"
        chat_id = update.effective_chat.id
        topic_id = getattr(update.effective_message, 'message_thread_id', None)
        
        print(f"üí¨ [RU-CMD] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} ({user_id}) –æ—Ç–ø—Ä–∞–≤–∏–ª: {text}")
        
        if text.startswith("–Ω–∞–ø–æ–º–Ω–∏:"):
            await self.handle_set_reminder_russian(update, context, text)
        elif text.startswith("—É–¥–∞–ª–∏:"):
            await self.handle_delete_reminder_russian(update, context, text)
        elif text.startswith("–ø—Ä–æ–≤–µ—Ä—å –ø–∞–º—è—Ç—å:"):
            await self.handle_list_reminders_russian(update, context, text)

    async def handle_set_reminder_russian(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str):
        chat_id = update.effective_chat.id
        topic_id = getattr(update.effective_message, 'message_thread_id', None)
        user_id = update.effective_user.id
        user_name = update.effective_user.first_name or "–ê–Ω–æ–Ω–∏–º"
        
        print(f"üìù [RU-SET] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} ({user_id}) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç '–Ω–∞–ø–æ–º–Ω–∏:' –≤ —á–∞—Ç–µ {chat_id} (–≤–µ—Ç–∫–∞: {topic_id})")
        
        if not self.is_allowed_chat(chat_id):
            await update.effective_message.reply_text("‚ùå –≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö.")
            return
        
        message_text = text[8:].strip()
        if not message_text:
            await update.effective_message.reply_text(
                "‚ùå –£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ '–Ω–∞–ø–æ–º–Ω–∏:'\n"
                "–ü—Ä–∏–º–µ—Ä: `–Ω–∞–ø–æ–º–Ω–∏: —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä`",
                parse_mode="Markdown"
            )
            print(f"‚ö†Ô∏è [RU-SET] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –Ω–µ —É–∫–∞–∑–∞–ª –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Å–ª–µ '–Ω–∞–ø–æ–º–Ω–∏:'")
            return
        
        reminder_time, message = self.parse_reminder_input(message_text)
        if not reminder_time:
            await update.effective_message.reply_text(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n"
                "- `2025-12-25 15:30 –°–æ–æ–±—â–µ–Ω–∏–µ`\n"
                "- `—á–µ—Ä–µ–∑ 1 —á–∞—Å –°–æ–æ–±—â–µ–Ω–∏–µ`"
            )
            print(f"‚ö†Ô∏è [RU-SET] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} —É–∫–∞–∑–∞–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: {message_text}")
            return
        
        reminder_id = f"{chat_id}_{topic_id or 0}_{int(reminder_time.timestamp())}"
        self.reminders[reminder_id] = {
            'chat_id': chat_id,
            'topic_id': topic_id,
            'user_id': user_id,
            'message': message,
            'time': reminder_time.isoformat(),
            'created_at': datetime.now().isoformat()
        }
        self.save_reminders()
        
        time_str = reminder_time.strftime('%d.%m.%Y %H:%M:%S')
        await update.effective_message.reply_text(
            f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ {time_str}\n"
            f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: {message}"
        )
        print(f"‚úÖ [RU-SET SUCCESS] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} —É—Å—Ç–∞–Ω–æ–≤–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: '{message}' –Ω–∞ {time_str} (ID: {reminder_id})")

    async def handle_delete_reminder_russian(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str):
        chat_id = update.effective_chat.id
        topic_id = getattr(update.effective_message, 'message_thread_id', None)
        user_id = update.effective_user.id
        user_name = update.effective_user.first_name or "–ê–Ω–æ–Ω–∏–º"
        
        print(f"üóëÔ∏è [RU-DEL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} ({user_id}) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç '—É–¥–∞–ª–∏:' –≤ —á–∞—Ç–µ {chat_id} (–≤–µ—Ç–∫–∞: {topic_id})")
        
        if not self.is_allowed_chat(chat_id):
            await update.effective_message.reply_text("‚ùå –≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö.")
            return
        
        time_str = text[6:].strip()
        if not time_str:
            await update.effective_message.reply_text(
                "‚ùå –£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ '—É–¥–∞–ª–∏:'\n"
                "–ü—Ä–∏–º–µ—Ä: `—É–¥–∞–ª–∏: 2025-12-25 15:30`"
            )
            print(f"‚ö†Ô∏è [RU-DEL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –Ω–µ —É–∫–∞–∑–∞–ª –≤—Ä–µ–º—è –ø–æ—Å–ª–µ '—É–¥–∞–ª–∏:'")
            return
        
        try:
            target_time = datetime.strptime(time_str, '%Y-%m-%d %H:%M')
        except ValueError:
            await update.effective_message.reply_text("‚ùå –§–æ—Ä–º–∞—Ç: `–ì–ì–ì–ì-–ú–ú-–î–î –ß–ß:–ú–ú`")
            print(f"‚ö†Ô∏è [RU-DEL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} —É–∫–∞–∑–∞–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏: {time_str}")
            return
        
        to_delete = None
        for reminder_id, reminder_data in self.reminders.items():
            if (reminder_data['chat_id'] == chat_id and
                reminder_data.get('topic_id') == topic_id and
                reminder_data['user_id'] == user_id and
                datetime.fromisoformat(reminder_data['time']) == target_time):
                to_delete = reminder_id
                break
        
        if to_delete:
            del self.reminders[to_delete]
            self.save_reminders()
            await update.effective_message.reply_text(
                f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ {target_time.strftime('%d.%m.%Y %H:%M')} —É–¥–∞–ª–µ–Ω–æ."
            )
            print(f"‚úÖ [RU-DEL SUCCESS] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} —É–¥–∞–ª–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ {target_time.strftime('%d.%m.%Y %H:%M')} (ID: {to_delete})")
        else:
            await update.effective_message.reply_text(
                f"‚ùå –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ {target_time.strftime('%d.%m.%Y %H:%M')} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —ç—Ç–æ–π –≤–µ—Ç–∫–µ –∏–ª–∏ –≤—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –µ–≥–æ –∞–≤—Ç–æ—Ä–æ–º."
            )
            print(f"‚ö†Ô∏è [RU-DEL FAILED] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –ø–æ–ø—ã—Ç–∞–ª—Å—è —É–¥–∞–ª–∏—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–ª–∏ —á—É–∂–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ")

    async def handle_list_reminders_russian(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str):
        chat_id = update.effective_chat.id
        topic_id = getattr(update.effective_message, 'message_thread_id', None)
        user_id = update.effective_user.id
        user_name = update.effective_user.first_name or "–ê–Ω–æ–Ω–∏–º"
        
        print(f"üìã [RU-LIST] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} ({user_id}) –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–≤–æ–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —á–∞—Ç–µ {chat_id} (–≤–µ—Ç–∫–∞: {topic_id})")
        
        if not self.is_allowed_chat(chat_id):
            await update.effective_message.reply_text("‚ùå –≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö.")
            return
        
        chat_reminders = {
            k: v for k, v in self.reminders.items()
            if v['chat_id'] == chat_id and v.get('topic_id') == topic_id and v['user_id'] == user_id
        }
        
        if not chat_reminders:
            await update.effective_message.reply_text("üìã –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —ç—Ç–æ–π –≤–µ—Ç–∫–µ.")
            print(f"‚úÖ [RU-LIST] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –Ω–µ –∏–º–µ–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
            return
        
        response = "üìã –í–∞—à–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —ç—Ç–æ–π –≤–µ—Ç–∫–µ:\n\n"
        for reminder_data in chat_reminders.values():
            time_str = datetime.fromisoformat(reminder_data['time']).strftime('%d.%m.%Y %H:%M:%S')
            response += f"‚Ä¢ {time_str} ‚Äî {reminder_data['message']}\n"
        
        await update.effective_message.reply_text(response)
        print(f"‚úÖ [RU-LIST SUCCESS] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –ø–æ–ª—É—á–∏–ª {len(chat_reminders)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")

    def parse_reminder_input(self, input_text: str) -> tuple[Optional[datetime], str]:
        parts = input_text.split()
        if len(parts) >= 3 and parts[0] == '—á–µ—Ä–µ–∑':
            try:
                amount = int(parts[1])
                unit = parts[2]
                now = datetime.now()
                if '—Å–µ–∫—É–Ω–¥' in unit:
                    delta = timedelta(seconds=amount)
                elif '–º–∏–Ω—É—Ç' in unit:
                    delta = timedelta(minutes=amount)
                elif '—á–∞—Å' in unit:
                    delta = timedelta(hours=amount)
                elif '–¥–Ω' in unit:
                    delta = timedelta(days=amount)
                else:
                    return None, input_text
                reminder_time = now + delta
                message_start = ' '.join(parts[:3])
                message = input_text[len(message_start):].strip()
                return reminder_time, message
            except (ValueError, IndexError):
                pass

        if len(input_text) >= 16 and input_text[4] == '-' and input_text[7] == '-':
            try:
                date_part = input_text[:16]
                reminder_time = datetime.strptime(date_part, '%Y-%m-%d %H:%M')
                message = input_text[17:].strip()
                return reminder_time, message
            except ValueError:
                pass

        return None, input_text

    async def list_reminders(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        topic_id = getattr(update.effective_message, 'message_thread_id', None)
        user_id = update.effective_user.id
        user_name = update.effective_user.first_name or "–ê–Ω–æ–Ω–∏–º"
        
        print(f"üìã [LIST] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} ({user_id}) –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–≤–æ–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —á–∞—Ç–µ {chat_id} (–≤–µ—Ç–∫–∞: {topic_id})")
        
        if not self.is_allowed_chat(chat_id):
            await update.effective_message.reply_text("‚ùå –≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö.")
            return
        
        chat_reminders = {
            k: v for k, v in self.reminders.items()
            if v['chat_id'] == chat_id and v.get('topic_id') == topic_id and v['user_id'] == user_id
        }
        
        if not chat_reminders:
            await update.effective_message.reply_text("üìã –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —ç—Ç–æ–π –≤–µ—Ç–∫–µ.")
            print(f"‚úÖ [LIST] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –Ω–µ –∏–º–µ–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
            return
        
        response = "üìã –í–∞—à–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —ç—Ç–æ–π –≤–µ—Ç–∫–µ:\n\n"
        for reminder_data in chat_reminders.values():
            time_str = datetime.fromisoformat(reminder_data['time']).strftime('%d.%m.%Y %H:%M:%S')
            response += f"‚Ä¢ {time_str} ‚Äî {reminder_data['message']}\n"
        
        await update.effective_message.reply_text(response)
        print(f"‚úÖ [LIST SUCCESS] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –ø–æ–ª—É—á–∏–ª {len(chat_reminders)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")

    async def delete_reminder(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        topic_id = getattr(update.effective_message, 'message_thread_id', None)
        user_id = update.effective_user.id
        user_name = update.effective_user.first_name or "–ê–Ω–æ–Ω–∏–º"
        
        print(f"üóëÔ∏è [DEL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} ({user_id}) –ø—ã—Ç–∞–µ—Ç—Å—è —É–¥–∞–ª–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ —á–∞—Ç–µ {chat_id} (–≤–µ—Ç–∫–∞: {topic_id})")
        
        if not self.is_allowed_chat(chat_id):
            await update.effective_message.reply_text("‚ùå –≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö.")
            return
        
        if not context.args:
            await update.effective_message.reply_text(
                "‚ùå –£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.\n"
                "–ü—Ä–∏–º–µ—Ä: `/delete_reminder 2025-12-25 15:30`",
                parse_mode="Markdown"
            )
            print(f"‚ö†Ô∏è [DEL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –Ω–µ —É–∫–∞–∑–∞–ª –≤—Ä–µ–º—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è")
            return
        
        time_str = " ".join(context.args[:2])
        try:
            target_time = datetime.strptime(time_str, '%Y-%m-%d %H:%M')
        except ValueError:
            await update.effective_message.reply_text("‚ùå –§–æ—Ä–º–∞—Ç: `–ì–ì–ì–ì-–ú–ú-–î–î –ß–ß:–ú–ú`")
            print(f"‚ö†Ô∏è [DEL] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} —É–∫–∞–∑–∞–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏: {time_str}")
            return
        
        to_delete = None
        for reminder_id, reminder_data in self.reminders.items():
            if (reminder_data['chat_id'] == chat_id and
                reminder_data.get('topic_id') == topic_id and
                reminder_data['user_id'] == user_id and
                datetime.fromisoformat(reminder_data['time']) == target_time):
                to_delete = reminder_id
                break
        
        if to_delete:
            del self.reminders[to_delete]
            self.save_reminders()
            await update.effective_message.reply_text(
                f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ {target_time.strftime('%d.%m.%Y %H:%M')} —É–¥–∞–ª–µ–Ω–æ."
            )
            print(f"‚úÖ [DEL SUCCESS] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} —É–¥–∞–ª–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ {target_time.strftime('%d.%m.%Y %H:%M')} (ID: {to_delete})")
        else:
            await update.effective_message.reply_text(
                f"‚ùå –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ {target_time.strftime('%d.%m.%Y %H:%M')} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —ç—Ç–æ–π –≤–µ—Ç–∫–µ –∏–ª–∏ –≤—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –µ–≥–æ –∞–≤—Ç–æ—Ä–æ–º."
            )
            print(f"‚ö†Ô∏è [DEL FAILED] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –ø–æ–ø—ã—Ç–∞–ª—Å—è —É–¥–∞–ª–∏—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–ª–∏ —á—É–∂–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ")

    async def show_help(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_id = update.effective_user.id
        user_name = update.effective_user.first_name or "–ê–Ω–æ–Ω–∏–º"
        chat_id = update.effective_chat.id
        print(f"‚ùì [HELP] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} ({user_id}) –∑–∞–ø—Ä–æ—Å–∏–ª —Å–ø—Ä–∞–≤–∫—É –≤ —á–∞—Ç–µ {chat_id}")
        
        help_text = (
            "ü§ñ <b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –±–æ—Ç–∞-–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</b>\n\n"
            "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
            "‚Ä¢ <code>/set_reminder</code> ‚Äî –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
            "‚Ä¢ <code>/reminders</code> ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\n"
            "‚Ä¢ <code>/delete_reminder</code> ‚Äî –£–¥–∞–ª–∏—Ç—å —Å–≤–æ—ë –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
            "‚Ä¢ <code>/help</code> ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n"
            "<b>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ (—Ä—É—Å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã):</b>\n"
            "‚Ä¢ <code>–Ω–∞–ø–æ–º–Ω–∏: —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ-—Ç–æ</code> ‚Äî –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
            "‚Ä¢ <code>—É–¥–∞–ª–∏: 2025-12-25 15:30</code> ‚Äî –£–¥–∞–ª–∏—Ç—å —Å–≤–æ—ë –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
            "‚Ä¢ <code>–ø—Ä–æ–≤–µ—Ä—å –ø–∞–º—è—Ç—å:</code> ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–≤–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —ç—Ç–æ–π –≤–µ—Ç–∫–µ\n\n"
            "<b>–§–æ—Ä–º–∞—Ç—ã –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏:</b>\n"
            "‚Ä¢ <code>2025-12-25 15:30</code> ‚Äî –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è\n"
            "‚Ä¢ <code>—á–µ—Ä–µ–∑ 1 —á–∞—Å</code> ‚Äî –ß–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è\n"
            "‚Ä¢ <code>—á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç</code> ‚Äî –ß–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è\n"
            "‚Ä¢ <code>—á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥</code> ‚Äî –ß–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è\n"
            "‚Ä¢ <code>—á–µ—Ä–µ–∑ 2 –¥–Ω—è</code> ‚Äî –ß–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è\n\n"
            "<b>–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</b>\n"
            "‚Ä¢ <code>/set_reminder —á–µ—Ä–µ–∑ 1 —á–∞—Å –í—Å—Ç—Ä–µ—á–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º</code>\n"
            "‚Ä¢ <code>–Ω–∞–ø–æ–º–Ω–∏: 2025-12-25 15:30 –ü–æ–∑–¥—Ä–∞–≤–∏—Ç—å —Å –ù–æ–≤—ã–º –≥–æ–¥–æ–º</code>\n"
            "‚Ä¢ <code>/reminders</code> ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–≤–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —ç—Ç–æ–π –≤–µ—Ç–∫–µ\n"
            "‚Ä¢ <code>–ø—Ä–æ–≤–µ—Ä—å –ø–∞–º—è—Ç—å:</code> ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–≤–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —ç—Ç–æ–π –≤–µ—Ç–∫–µ\n"
            "‚Ä¢ <code>/delete_reminder 2025-12-25 15:30</code> ‚Äî –£–¥–∞–ª–∏—Ç—å —Å–≤–æ—ë –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
            "‚Ä¢ <code>—É–¥–∞–ª–∏: 2025-12-25 15:30</code> ‚Äî –£–¥–∞–ª–∏—Ç—å —Å–≤–æ—ë –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n\n"
            "‚ö†Ô∏è –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —á–∞—Ç–∞—Ö –∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤–µ—Ç–∫–∏ —Ñ–æ—Ä—É–º–æ–≤.\n"
            "‚ö†Ô∏è –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∏ —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è."
        )
        await update.effective_message.reply_text(help_text, parse_mode="HTML")

    async def reminder_checker(self):
        while self.running:
            await self.check_reminders()
            await asyncio.sleep(10)

    def run(self):
        print("üü¢ [START] –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º...")
        print(f"üîµ [CONFIG] –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —á–∞—Ç—ã: {CHAT_IDS}")
        print(f"üîµ [CONFIG] –§–∞–π–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {REMINDERS_FILE}")
        print("üü† [INFO] –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥...")
        
        import threading
        reminder_thread = threading.Thread(target=lambda: asyncio.run(self.reminder_checker()), daemon=True)
        reminder_thread.start()

        self.application.run_polling()


def load_token_from_file(filename: str) -> str:
    try:
        with open(filename, 'r', encoding='utf-8') as f:
            content = f.read().strip()
            lines = content.split('\n')
            for line in lines:
                if line.startswith('BOT_TOKEN ='):
                    token = line.split('=', 1)[1].strip().strip('"\'')
                    print(f"üîë [TOKEN] –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ {filename}")
                    return token
        raise ValueError("–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ")
    except FileNotFoundError:
        print(f"üî¥ [ERROR] –§–∞–π–ª {filename} –Ω–µ –Ω–∞–π–¥–µ–Ω")
        raise
    except Exception as e:
        print(f"üî¥ [ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞: {e}")
        raise


if __name__ == "__main__":
    BOT_TOKEN = load_token_from_file("token.txt")
    bot = ReminderBot(BOT_TOKEN)
    bot.run()
